<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Listado de Proveedores</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/navbar-style.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbarFragment}"></div>
<div class="container mt-4">
    <h2>Listado de Proveedores</h2>
    <!-- Filtros y botones -->
    <div class="d-flex justify-content-between mb-3">
        <div>
            <!-- TODO: Filtros -->
        </div>
        <div>
            <a th:href="@{/proveedores/nuevo}" class="btn btn-primary me-2">+</a>
            <!-- Dropdown para selección de columnas -->
            <div class="dropdown d-inline-block">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownColumnas" data-bs-toggle="dropdown" aria-expanded="false">
                    ⚙️
                </button>
                <ul class="dropdown-menu p-2" aria-labelledby="dropdownColumnas" id="columnChecklist">
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="seleccionar-todos" id="check-seleccionar-todos"><label class="form-check-label" for="check-seleccionar-todos">Seleccionar Todos</label></div></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="id" id="check-id" checked><label class="form-check-label" for="check-id">ID</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="nombre-proveedor" id="check-nombre-proveedor" checked><label class="form-check-label" for="check-nombre-proveedor">Nombre Proveedor</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="razon-social" id="check-razon-social" checked><label class="form-check-label" for="check-razon-social">Razón Social</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="cuit" id="check-cuit" checked><label class="form-check-label" for="check-cuit">CUIT</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="telefono" id="check-telefono" checked><label class="form-check-label" for="check-telefono">Teléfono</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="correo" id="check-correo" checked><label class="form-check-label" for="check-correo">Correo</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="provincia" id="check-provincia" checked><label class="form-check-label" for="check-provincia">Provincia</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="ciudad" id="check-ciudad" checked><label class="form-check-label" for="check-ciudad">Ciudad</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="codigo-postal" id="check-codigo-postal" checked><label class="form-check-label" for="check-codigo-postal">Código Postal</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="direccion" id="check-direccion" checked><label class="form-check-label" for="check-direccion">Dirección</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="banco" id="check-banco" checked><label class="form-check-label" for="check-banco">Banco</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="numero-cuenta" id="check-numero-cuenta" checked><label class="form-check-label" for="check-numero-cuenta">Número de Cuenta</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="tipo-proveedor" id="check-tipo-proveedor" checked><label class="form-check-label" for="check-tipo-proveedor">Tipo de Proveedor</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="rubro" id="check-rubro" checked><label class="form-check-label" for="check-rubro">Rubro</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="activo" id="check-activo" checked><label class="form-check-label" for="check-activo">Activo</label></div></li>
                    <li><div class="form-check dropdown-item px-4"><input class="form-check-input" type="checkbox" value="acciones" id="check-acciones" checked><label class="form-check-label" for="check-acciones">Acciones</label></div></li>
                    <li><div class="form-check dropdown-item px-4" th:if="${#authorization.expression('hasRole(''ADMIN'')')}"><input class="form-check-input" type="checkbox" value="creado-por" id="check-creado-por" checked><label class="form-check-label" for="check-creado-por">Creado Por</label></div></li>
                    <li><div class="form-check dropdown-item px-4" th:if="${#authorization.expression('hasRole(''ADMIN'')')}"><input class="form-check-input" type="checkbox" value="fecha-reg" id="check-fecha-reg" checked><label class="form-check-label" for="check-fecha-reg">Fecha Registro</label></div></li>
                </ul>
            </div>
        </div>
    </div>
    <table class="table table-striped" id="tablaProveedores">
<thead>
            <tr>
                <th id="id">ID</th>
                <th id="nombre">Nombre Proveedor</th>
                <th id="razon-social">Razón Social</th>
                <th id="cuit">CUIT</th>
                <th id="telefono">Teléfono</th>
                <th id="correo">Correo</th>
                <th id="provincia">Provincia</th>
                <th id="ciudad">Ciudad</th>
                <th id="codigo-postal">Código Postal</th>
                <th id="direccion">Dirección</th>
                <th id="banco">Banco</th>
                <th id="numero-cuenta">Número de Cuenta</th>
                <th id="tipo-proveedor">Tipo de Proveedor</th>
                <th id="rubro">Rubro</th>
                <th id="creado-por" th:if="${#authorization.expression('hasRole(''ADMIN'')')}">Creado Por</th>
                <th id="fecha-reg" th:if="${#authorization.expression('hasRole(''ADMIN'')')}">Fecha Reg.</th>
                <th id="activo">Activo</th>
                <th id="acciones">Acciones</th>
            </tr>
        </thead>
        <tbody>
            <tr th:each="p : ${proveedores}">
                <td headers="id" th:text="${p.id}"></td>
                <td headers="nombre" th:text="${p.nombre}"></td>
                <td headers="razon-social" th:text="${p.razonSocial}"></td>
                <td headers="cuit" th:text="${p.cuit}"></td>
                <td headers="telefono" th:text="${p.telefono}"></td>
                <td headers="correo" th:text="${p.correo}"></td>
                <td headers="provincia" th:text="${p.provincia}"></td>
                <td headers="ciudad" th:text="${p.ciudad}"></td>
                <td headers="codigo-postal" th:text="${p.codigoPostal}"></td>
                <td headers="direccion" th:text="${p.direccion}"></td>
                <td headers="banco" th:text="${p.banco}"></td>
                <td headers="numero-cuenta" th:text="${p.numeroCuenta}"></td>
                <td headers="tipo-proveedor" th:text="${p.tipoProveedor?.nombre}"></td>
                <td headers="rubro" th:text="${p.rubro?.nombre}"></td>
                <td headers="creado-por" th:if="${#authorization.expression('hasRole(''ADMIN'')')}" th:text="${p.creadoPor}"></td>
                <td headers="fecha-reg" th:if="${#authorization.expression('hasRole(''ADMIN'')')}" th:text="${#temporals.format(p.fechaCreacion, 'dd/MM/yyyy HH:mm')}"></td>
                <td headers="activo">
                    <span th:if="${p.activo}" class="badge bg-success">Sí</span>
                    <span th:unless="${p.activo}" class="badge bg-danger">No</span>
                </td>
                <td headers="acciones">
                    <a th:href="@{/proveedores/editar/{id}(id=${p.id})}" class="btn btn-sm btn-warning">✏️</a>
                    
                    <span th:if="${p.activo}">
                        <form th:action="@{/proveedores/desactivar/{id}(id=${p.id})}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-sm btn-danger">DESACTIVAR</button>
                        </form>
                    </span>
                    <span th:unless="${p.activo}">
                        <form th:action="@{/proveedores/activar/{id}(id=${p.id})}" method="post" style="display:inline;">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                            <button type="submit" class="btn btn-sm btn-success">ACTIVAR</button>
                        </form>
                    </span>
                </td>
            </tr>
            <tr th:if="${proveedores.empty}">
                <td colspan="18" class="text-center text-muted italic">No hay proveedores registrados en el sistema.</td>
            </tr>
        </tbody>
    </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {
    const columnChecklist = document.getElementById('columnChecklist');
    const table = document.getElementById('tablaProveedores');
    // Select all checkboxes except the "Seleccionar Todos" one for individual column control
    const individualCheckboxes = columnChecklist.querySelectorAll('input[type="checkbox"]:not([value="seleccionar-todos"])');
    const selectAllCheckbox = document.getElementById('check-seleccionar-todos');

    // Function to apply column visibility
    function applyColumnVisibility() {
        individualCheckboxes.forEach(checkbox => {
            const columnId = checkbox.value; // e.g., "nombre-proveedor"
            const isVisible = checkbox.checked;

            // Find the header by ID
            const headerElement = document.getElementById(columnId);
            if (headerElement) {
                headerElement.style.display = isVisible ? '' : 'none';
            }

            // Find all cells related to this column using the headers attribute
            const cells = table.querySelectorAll(`td[headers="${columnId}"]`);
            cells.forEach(cell => {
                cell.style.display = isVisible ? '' : 'none';
            });
        });
    }

    // Load saved preferences from localStorage
    function loadColumnPreferences() {
        let savedPreferences = localStorage.getItem('proveedoresColumnVisibility');
        if (savedPreferences) {
            savedPreferences = JSON.parse(savedPreferences);
            individualCheckboxes.forEach(checkbox => {
                // Default to checked if not explicitly saved as false
                checkbox.checked = savedPreferences[checkbox.value] !== false;
            });
        } else {
            // If no preferences saved, ensure all are checked by default and save
            individualCheckboxes.forEach(checkbox => {
                checkbox.checked = true;
            });
            saveColumnPreferences(); // Save initial state
        }
        updateSelectAllCheckboxState(); // Update "Select All" based on loaded preferences
        applyColumnVisibility(); // Apply visibility based on loaded preferences
    }

    // Save preferences to localStorage
    function saveColumnPreferences() {
        const preferences = {};
        individualCheckboxes.forEach(checkbox => {
            preferences[checkbox.value] = checkbox.checked;
        });
        localStorage.setItem('proveedoresColumnVisibility', JSON.stringify(preferences));
    }

    // Update "Select All" checkbox state (checked, unchecked, indeterminate)
    function updateSelectAllCheckboxState() {
        const totalIndividualCheckboxes = individualCheckboxes.length;
        const checkedIndividualCheckboxes = Array.from(individualCheckboxes).filter(cb => cb.checked).length;

        if (checkedIndividualCheckboxes === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedIndividualCheckboxes === totalIndividualCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // Event listener for main checkbox changes
    columnChecklist.addEventListener('change', function(event) {
        // Stop propagation to prevent dropdown from closing
        event.stopPropagation();

        if (event.target.type === 'checkbox') {
            if (event.target.id === 'check-seleccionar-todos') {
                const isChecked = selectAllCheckbox.checked;
                individualCheckboxes.forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            }
            saveColumnPreferences();
            applyColumnVisibility();
            updateSelectAllCheckboxState(); // Update "Select All" after individual changes
        }
    });

    // Prevent dropdown from closing on click inside, for the dropdown menu itself
    columnChecklist.addEventListener('click', function(event) {
        event.stopPropagation();
    });

    // Initial load of preferences
    loadColumnPreferences();
});
/*]]>*/
</script>
</body>
</html>
