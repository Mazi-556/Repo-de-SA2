<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Solicitud de Compra</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbarFragment}"></div>
<div class="container mt-4">
    <h2>Solicitud de Compra</h2>
    <form th:action="@{/solicitudes-compra/guardar}" th:object="${solicitud}" method="post" class="card p-4">
        <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones</label>
            <textarea class="form-control" id="observaciones" th:field="*{observaciones}" rows="3"></textarea>
        </div>

        <h4>Productos</h4>
        <div class="row align-items-end mb-3">
            <div class="col-md-6">
                <label for="productoSeleccionado" class="form-label">Producto</label>
                <select id="productoSeleccionado" class="form-select">
                    <option value="">Seleccionar producto...</option>
                    <option th:each="prod : ${productos}" 
                            th:value="${prod.id}" 
                            th:text="${prod.nombre}"
                            th:data-descripcion="${prod.descripcion}"
                            th:data-precio="${prod.precioCosto}"></option>
                </select>
            </div>
            <div class="col-md-4">
                <label for="cantidadProducto" class="form-label">Cantidad</label>
                <input type="number" class="form-control" id="cantidadProducto" value="1" min="1">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-success w-100" id="agregarProductoBtn">+ AGREGAR</button>
            </div>
        </div>

        <div class="mb-4">
            <table class="table table-striped" id="solicitudItemsTable">
                <thead>
                    <tr>
                        <th>Producto</th>
                        <th>Descripci√≥n</th>
                        <th>Cantidad</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Filas de productos se agregar√°n aqu√≠ din√°micamente con JavaScript -->
                </tbody>
            </table>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary">CREAR SOLICITUD</button>
            <a th:href="@{/solicitudes-compra}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
/*<![CDATA[*/
document.addEventListener('DOMContentLoaded', function() {
    const productoSeleccionado = document.getElementById('productoSeleccionado');
    const cantidadProducto = document.getElementById('cantidadProducto');
    const agregarProductoBtn = document.getElementById('agregarProductoBtn');
    const solicitudItemsTableBody = document.querySelector('#solicitudItemsTable tbody');

    let itemIndex = 0;

    agregarProductoBtn.addEventListener('click', function() {
        const option = productoSeleccionado.options[productoSeleccionado.selectedIndex];
        const selectedProductId = option.value;
        const productName = option.text;
        const productDesc = option.getAttribute('data-descripcion') || '';
        const productPrecio = option.getAttribute('data-precio') || '0';

        if (!selectedProductId) {
            alert('Por favor, selecciona un producto.');
            return;
        }

        const cantidad = parseInt(cantidadProducto.value);
        if (isNaN(cantidad) || cantidad <= 0) {
            alert('Por favor, ingresa una cantidad v√°lida.');
            return;
        }

        const existingRow = solicitudItemsTableBody.querySelector(`tr[data-product-id="${selectedProductId}"]`);
        
        if (existingRow) {
            const inputCant = existingRow.querySelector(`input[name$='\\.cantidad']`);
            const nuevaCant = parseInt(inputCant.value) + cantidad;
            inputCant.value = nuevaCant;
            existingRow.querySelector('.cantidad-display').textContent = nuevaCant;
        } else {
            const newRow = document.createElement('tr');
            newRow.setAttribute('data-product-id', selectedProductId);
            newRow.innerHTML = `
                <td>${productName}<input type="hidden" name="items[${itemIndex}].producto.id" value="${selectedProductId}"></td>
                <td>${productDesc}<input type="hidden" name="items[${itemIndex}].descripcion" value="${productDesc}"><input type="hidden" name="items[${itemIndex}].precioUnitario" value="${productPrecio}"></td>
                <td><span class="cantidad-display">${cantidad}</span><input type="hidden" name="items[${itemIndex}].cantidad" value="${cantidad}"></td>
                <td><button type="button" class="btn btn-danger btn-sm eliminar-producto">üóëÔ∏è</button></td>
            `;
            solicitudItemsTableBody.appendChild(newRow);
            itemIndex++;
            newRow.querySelector('.eliminar-producto').addEventListener('click', () => newRow.remove());
        }
        productoSeleccionado.value = '';
        cantidadProducto.value = '1';
    });
});
/*]]>*/
</script>
