<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <title>Plan de Cuentas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .tree-row { 
            background-color: #fff;
        }
        .tree-row-level-1 { 
            background-color: #f9f9f9;
            font-weight: 500;
        }
        .tree-row-level-2 { background-color: #fff; }
        .tree-row-level-3 { background-color: #f5f5f5; }
        .tree-row-level-4 { background-color: #fff; }
        .tree-row-level-5 { background-color: #f5f5f5; }
        
        .tree-row.hidden { display: none; }
        
        .tree-expand-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px 8px;
            font-size: 14px;
            width: 24px;
            height: 24px;
            text-align: center;
            color: #666;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 8px;
        }
        
        .tree-expand-btn:hover {
            color: #000;
            background-color: #eee;
            border-radius: 3px;
        }
        
        .tree-expand-btn.no-children {
            visibility: hidden;
        }
        
        .tree-code-cell {
            display: flex;
            align-items: center;
        }
        
        .tree-row-level-1 .tree-code-cell { padding-left: 0; }
        .tree-row-level-2 .tree-code-cell { padding-left: 24px; }
        .tree-row-level-3 .tree-code-cell { padding-left: 48px; }
        .tree-row-level-4 .tree-code-cell { padding-left: 72px; }
        .tree-row-level-5 .tree-code-cell { padding-left: 96px; }
    </style>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbarFragment}"></div>

<div class="container mt-4">
    <h1>Plan de Cuentas</h1>

    <div th:if="${error}" class="alert alert-danger" role="alert">
        <p th:text="${error}"></p>
    </div>

    <div sec:authorize="hasRole('ADMIN')" class="mb-3">
        <a th:href="@{/admin/cuentas/nuevo}" class="btn btn-primary">Agregar Cuenta</a>
    </div>
    <div class="mb-3">
        <button type="button" class="btn btn-secondary" onclick="history.back()">Volver</button>
    </div>

    <table class="table table-striped">
        <thead>
        <tr>
            <th>Código</th>
            <th>Nombre</th>
            <th>Tipo de Cuenta</th>
            <th>Estado</th>
            <th sec:authorize="hasRole('ADMIN')">Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="cuenta : ${cuentas}" th:data-id="${cuenta.id}" th:data-padre-id="${cuenta.cuentaPadreId}" class="tree-row" th:attr="data-level=1">
            <td class="tree-code-cell">
                <button class="tree-expand-btn" onclick="toggleChildren(this)"></button>
                <span th:text="${cuenta.codigo}"></span>
            </td>
            <td th:text="${cuenta.nombre}"></td>
            <td th:text="${cuenta.tipoCuenta}"></td>
            <td>
                <span th:if="${cuenta.activo}" class="badge bg-success">Activa</span>
                <span th:unless="${cuenta.activo}" class="badge bg-danger">Inactiva</span>
            </td>
            <td sec:authorize="hasRole('ADMIN')">
                <div class="form-check form-switch d-inline-block me-2">
                    <input class="form-check-input" type="checkbox" role="switch" th:id="${'activoSwitch' + cuenta.id}"
                           th:checked="${cuenta.activo}"
                           onchange="document.getElementById('toggleForm' + this.id).submit()">
                    <label class="form-check-label" th:for="${'activoSwitch' + cuenta.id}">Activar/Desactivar</label>
                </div>
                <form th:id="${'toggleFormactivoSwitch' + cuenta.id}" th:action="@{/admin/cuentas/toggleActivo/{id}(id=${cuenta.id})}" method="post" style="display: none;"></form>

                <a th:href="@{/admin/cuentas/editar/{id}(id=${cuenta.id})}" class="btn btn-sm btn-warning">Editar</a>
                <a th:href="@{/admin/cuentas/eliminar/{id}(id=${cuenta.id})}" class="btn btn-sm btn-danger">Eliminar</a>
            </td>
        </tr>
        </tbody>
    </table>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tbody = document.querySelector('table tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Crear un mapa de IDs a filas
    const rowsMap = {};
    const childrenMap = {};
    
    rows.forEach(row => {
        const id = row.getAttribute('data-id');
        rowsMap[id] = row;
    });
    
    // Función para calcular el nivel de profundidad
    function getLevel(id, visited = new Set()) {
        if (visited.has(id)) return 0;
        visited.add(id);
        
        const row = rowsMap[id];
        if (!row) return 0;
        
        const padreId = row.getAttribute('data-padre-id');
        if (!padreId || padreId === 'null' || padreId === '') {
            return 1;
        }
        
        return 1 + getLevel(padreId, visited);
    }
    
    // Reorganizar las filas en orden de árbol
    function reorganizeTree() {
        const orderedRows = [];
        const processed = new Set();
        
        function addRowAndChildren(id, parentId = null) {
            if (processed.has(id)) return;
            processed.add(id);
            
            const row = rowsMap[id];
            if (row) {
                const level = getLevel(id);
                row.setAttribute('data-level', level);
                row.classList.remove(...Array.from(row.classList).filter(c => c.startsWith('tree-row-level')));
                row.classList.add('tree-row-level-' + level);
                orderedRows.push(row);
                
                // Guardar información de hijos
                if (!childrenMap[id]) childrenMap[id] = [];
            }
            
            // Agregar todos los hijos
            rows.forEach(r => {
                if (r.getAttribute('data-padre-id') === id && !processed.has(r.getAttribute('data-id'))) {
                    if (!childrenMap[id]) childrenMap[id] = [];
                    childrenMap[id].push(r.getAttribute('data-id'));
                    addRowAndChildren(r.getAttribute('data-id'), id);
                }
            });
        }
        
        // Procesar raíces primero
        rows.forEach(row => {
            const padreId = row.getAttribute('data-padre-id');
            if (!padreId || padreId === 'null' || padreId === '') {
                addRowAndChildren(row.getAttribute('data-id'));
            }
        });
        
        // Limpiar y recargar la tabla
        tbody.innerHTML = '';
        orderedRows.forEach(row => {
            tbody.appendChild(row);
        });
        
        // Actualizar botones de expandir
        updateExpandButtons();
    }
    
    function updateExpandButtons() {
        rows.forEach(row => {
            const id = row.getAttribute('data-id');
            const btn = row.querySelector('.tree-expand-btn');
            const hasChildren = childrenMap[id] && childrenMap[id].length > 0;
            
            if (hasChildren) {
                btn.classList.remove('no-children');
                btn.textContent = '▼';
                btn.setAttribute('data-expanded', 'true');
            } else {
                btn.classList.add('no-children');
                btn.textContent = '';
            }
        });
    }
    
    reorganizeTree();
});

function toggleChildren(btn) {
    const row = btn.closest('tr');
    const id = row.getAttribute('data-id');
    const isExpanded = btn.getAttribute('data-expanded') === 'true';
    const tbody = row.closest('tbody');
    
    // Encontrar todos los hijos directos e indirectos
    function getDescendantIds(parentId, allRows) {
        const descendants = [];
        allRows.forEach(r => {
            if (r.getAttribute('data-padre-id') === parentId) {
                const childId = r.getAttribute('data-id');
                descendants.push(childId);
                descendants.push(...getDescendantIds(childId, allRows));
            }
        });
        return descendants;
    }
    
    const allRows = Array.from(tbody.querySelectorAll('tr'));
    const descendantIds = getDescendantIds(id, allRows);
    
    // Alternar visibilidad
    descendantIds.forEach(childId => {
        const childRow = allRows.find(r => r.getAttribute('data-id') === childId);
        if (childRow) {
            if (isExpanded) {
                childRow.classList.add('hidden');
            } else {
                childRow.classList.remove('hidden');
            }
        }
    });
    
    // Cambiar icono
    btn.textContent = isExpanded ? '▶' : '▼';
    btn.setAttribute('data-expanded', isExpanded ? 'false' : 'true');
}
</script>
</body>
</html>
