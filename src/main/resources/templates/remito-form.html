<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Alta de Remitos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/navbar-style.css" rel="stylesheet">
</head>
<body>
<div th:replace="~{fragments/navbar :: navbarFragment}"></div>
<div class="container mt-4">
    <h2>Alta de Remitos</h2>
    <form th:action="@{/remitos/confirmar}" method="post" class="card p-4">
        
        <input type="hidden" name="ocId" th:value="${ordenCompra.id}" />

        <div class="mb-4">
            <p><strong>Orden de Compra:</strong> <span th:text="${'OC-' + ordenCompra.id}">OC-1</span></p>
            <p><strong>Proveedor:</strong> <span th:text="${ordenCompra.proveedor.nombre}">MotoProveedores Sociedad Anónima</span></p>
        </div>

        <div class="mb-4">
            <label for="fechaRemito" class="form-label">Fecha de Remito</label>
            <input type="date" id="fechaRemito" name="fechaRemito" class="form-control" required>
        </div>

        <h4>Items a Recibir</h4>
        <table class="table">
            <thead>
                <tr>
                    <th>Seleccionar</th>
                    <th>Código Producto</th>
                    <th>Nombre</th>
                    <th>Marca</th>
                    <th>Cantidad Pendiente</th>
                    <th>Cantidad Recibida</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item, iterStat : ${pendingItems}">
                    <td><input type="checkbox" name="itemIds" th:value="${item.id}"></td>
                    <td th:text="${item.producto.codigo}">PROD-001</td>
                    <td th:text="${item.producto.nombre}">Tornillo Phillips</td>
                    <td th:text="${item.producto.marca}">Marca A</td>
                    <td th:text="${item.cantidadPendiente}">100</td>
                    <td><input type="number" class="form-control cantidad-input" th:name="'cantidades[' + ${item.id} + ']'" value="1" min="1" th:max="${item.cantidadPendiente}"></td>
                </tr>
            </tbody>
        </table>

        <div class="mt-4">
            <button type="submit" id="confirmarRemitoBtn" class="btn btn-primary" disabled>CONFIRMAR REMITO</button>
            <a th:href="@{/remitos}" class="btn btn-secondary">Cancelar</a>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const confirmButton = document.getElementById('confirmarRemitoBtn');
        const fechaRemitoInput = document.getElementById('fechaRemito');
        const hoy = new Date().toISOString().split('T')[0];
        fechaRemitoInput.setAttribute('max', hoy);
        const itemCheckboxes = document.querySelectorAll('input[name="itemIds"]');

        function validateForm() {
            const isDateSelected = fechaRemitoInput.value !== '';
            let isAnyCheckboxChecked = false;
            let allQuantitiesValid = true;
            
            itemCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    isAnyCheckboxChecked = true;
                    // Verificar que la cantidad del item seleccionado sea mayor a 0
                    const row = checkbox.closest('tr');
                    const cantidadInput = row.querySelector('.cantidad-input');
                    if (cantidadInput && parseInt(cantidadInput.value) < 1) {
                        allQuantitiesValid = false;
                    }
                }
            });
            confirmButton.disabled = !(isDateSelected && isAnyCheckboxChecked && allQuantitiesValid);
        }

        fechaRemitoInput.addEventListener('input', validateForm);
        itemCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', validateForm);
        });
        
        // Agregar validación cuando cambian las cantidades
        document.querySelectorAll('.cantidad-input').forEach(input => {
            input.addEventListener('input', validateForm);
        });

        // Initial validation check
        validateForm();
    });
</script>
</body>
</html>
