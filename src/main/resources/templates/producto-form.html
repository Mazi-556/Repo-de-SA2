<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Alta de Producto</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/navbar-style.css" rel="stylesheet">
    <script src="http://localhost:35729/livereload.js"></script>
</head>
<body>
<div th:replace="~{fragments/navbar :: navbarFragment}"></div>
<div class="container mt-4">
    <h2>Alta de Producto</h2>
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>⚠️ Error:</strong> <span th:text="${error}"></span>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    <form th:action="@{/productos/guardar}" th:object="${producto}" method="post" class="card p-4">
        <input type="hidden" th:field="*{id}" />

        <h4>Datos Principales</h4>
        <hr>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label for="codigo" class="form-label">Código de Barras</label>
                <input type="text" class="form-control" id="codigo" th:field="*{codigo}" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="nombre" class="form-label">Nombre</label>
                <input type="text" class="form-control" id="nombre" th:field="*{nombre}" required>
            </div>
            <div class="col-md-6 mb-3">
                <label for="marca" class="form-label">Marca</label>
                <input type="text" class="form-control" id="marca" th:field="*{marca}">
            </div>
            <div class="col-md-6 mb-3">
                <label for="modelo" class="form-label">Modelo</label>
                <input type="text" class="form-control" id="modelo" th:field="*{modelo}">
            </div>
            <div class="col-12 mb-3">
                <label for="descripcion" class="form-label">Descripción</label>
                <textarea class="form-control" id="descripcion" th:field="*{descripcion}" rows="3"></textarea>
            </div>
        </div>

        <h4 class="mt-4">Stock</h4>
        <hr>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="stockMinimo" class="form-label">Stock Mínimo</label>
                <input type="number" class="form-control" id="stockMinimo" th:field="*{stockMinimo}" min="0" step="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="stockMaximo" class="form-label">Stock Máximo</label>
                <input type="number" class="form-control" id="stockMaximo" th:field="*{stockMaximo}" min="0" step="1" required>
            </div>
            <div class="col-md-4 mb-3">
                <label for="puntoReposicion" class="form-label">Punto de Reposición</label>
                <input type="number" class="form-control" id="puntoReposicion" th:field="*{puntoReposicion}" min="0" step="1" required>
            </div>
        </div>

        <h4 class="mt-4">Otros</h4>
        <hr>
        <div class="col-md-4 mb-3">
            <label for="precioCosto" class="form-label">Precio de Costo</label>
            <input type="number" step="0.01" class="form-control" id="precioCosto" th:field="*{precioCosto}" min="0">
        </div>
        <div class="row">
            <div class="col-md-4 mb-3">
                <label for="precioVenta" class="form-label">Precio de Venta</label>
                <input type="number" step="0.01" class="form-control" id="precioVenta" th:field="*{precioVenta}" min="0">
            </div>
            <div class="col-md-4 mb-3">
                <label for="iva" class="form-label">IVA %</label>
                <input type="number" step="0.01" class="form-control" id="iva" th:field="*{iva}" value="21.00" min="0" max="100">
            </div>
            <div class="col-md-4 mb-3">
                <label for="categoria" class="form-label">Categoría <span class="text-danger">*</span></label>
                <select class="form-select" id="categoria" th:field="*{categoria}" required>
                    <option value="">Seleccionar...</option>
                    <option th:each="cat : ${categorias}" th:value="${cat.id}" th:text="${cat.nombre}"></option>
                </select>
            </div>
             <div class="col-md-4 mb-3">
                <label for="almacen" class="form-label">Almacén <span class="text-danger">*</span></label>
                <select class="form-select" id="almacen" th:field="*{almacen}" required>
                    <option value="">Seleccionar...</option>
                    <option th:each="alm : ${almacenes}" th:value="${alm.id}" th:text="${alm.nombre}"></option>
                </select>
            </div>
        </div>

        <div class="mt-4">
            <button type="submit" class="btn btn-primary" 
                th:text="${producto.id == null ? 'Guardar y Continuar a Proveedores' : 'Guardar Cambios'}">
            </button>
            
            <a th:href="@{/productos}" class="btn btn-secondary">Cancelar</a>
            
            <a th:if="${producto.id}" th:href="@{/productos/asignar-proveedor/{id}(id=${producto.id})}" class="btn btn-info">Gestionar Proveedores</a>
        </div>
    </form>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Validaciones adicionales al enviar el formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        const stockMin = parseFloat(document.getElementById('stockMinimo').value) || 0;
        const stockMax = parseFloat(document.getElementById('stockMaximo').value) || 0;
        const puntoRepo = parseFloat(document.getElementById('puntoReposicion').value) || 0;
        
        // Validar stock mínimo vs máximo
        if (stockMin > 0 && stockMax > 0 && stockMin > stockMax) {
            e.preventDefault();
            alert('⚠️ El stock mínimo no puede ser mayor que el stock máximo.');
            return false;
        }
        
        // Validar punto de reposición
        if (puntoRepo > 0 && stockMin > 0 && puntoRepo < stockMin) {
            e.preventDefault();
            alert('⚠️ El punto de reposición no puede ser menor que el stock mínimo.');
            return false;
        }
        
        if (puntoRepo > 0 && stockMax > 0 && puntoRepo > stockMax) {
            e.preventDefault();
            alert('⚠️ El punto de reposición no puede ser mayor que el stock máximo.');
            return false;
        }
    });
</script>
</body>
</html>